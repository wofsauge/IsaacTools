<!DOCTYPE html>
<html>

<body>

    <h1>Text generator</h1>
    <label for="fname">Text: </label>
    <textarea id="text" rows="4" cols="25" autocomplete="off">Some demo Text !?$
New line
1234567890
    </textarea>
    <br>
    <label for="fname">Seed:</label>
    <input type="text" id="seed" autocomplete="off">
    <button id="reseed" onclick="
    seedBox.value = getRandomInt(999999);renderImage();" autocomplete="off">Reseed</button>
    <br>
    <br>
    <canvas id="textCanvas" style="border: 1px dotted black;">
        Your browser does not support the canvas tag.
        </canvas>


    <script>
        var validChars = {
            a: 4,
            b: 1,
            c: 2,
            d: 3,
            e: 2,
            f: 1,
            g: 2,
            h: 3,
            i: 2,
            j: 1,
            k: 3,
            l: 2,
            m: 2,
            n: 2,
            o: 4,
            p: 3,
            q: 1,
            r: 2,
            s: 3,
            t: 1,
            u: 3,
            v: 2,
            w: 2,
            x: 2,
            y: 1,
            z: 2,
            "1": 1,
            "2": 1,
            "3": 3,
            "4": 2,
            "5": 1,
            "6": 2,
            "7": 2,
            "8": 1,
            "9": 1,
            "0": 2,
            "!": 1,
            "?": 3,
            ".": 1,
            "$": 3
        };
        var seedBox = document.getElementById("seed");
        seedBox.value = getRandomInt(999999);
        seedBox.addEventListener('input', function(evt) {
            renderImage();
        });


        var inputBox = document.getElementById("text");
        inputBox.addEventListener('input', function(evt) {
            renderImage();
        });
        renderImage();

        function renderImage() {
            var c = document.getElementById("textCanvas");
            var ctx = c.getContext("2d");
            ctx.clearRect(0, 0, c.width, c.height);

            var chars = inputBox.value.toLowerCase().replace(/\r?\n/g, '#');
            chars = chars.split("");

            var sources = [];
            for (i = 0; i < chars.length; i++) {
                if (validChars[chars[i]] != null) {
                    sources.push(getImagePath(chars[i], i));
                } else if (chars[i] == " ") {
                    sources.push(i + "#space");
                } else if (chars[i] == "#") {
                    sources.push(i + "#enter");
                }
            }

            loadImages(sources, function(images) {
                var imagesToDraw = [];
                imagesToDraw.push([]);
                var lineCount = 0;
                var offsetX = 0;
                var offsetY = 0;
                for (const [key, value] of Object.entries(images)) {
                    if (("" + value).includes("#enter")) {
                        offsetY = offsetY + 20;
                        offsetX = 0;
                        lineCount++;
                        imagesToDraw.push([]);
                        continue
                    }
                    var offsetWidth = 10;
                    if (!("" + value).includes("#")) {
                        imagesToDraw[lineCount].push([value, offsetX, offsetY]);
                        offsetWidth = value.width;
                    }
                    offsetX = offsetX + offsetWidth;
                }
                imagesToDraw.forEach(line => {
                    line.forEach(img => {
                        ctx.drawImage(img[0], img[1], img[2]);
                    });
                });
            });
        }

        function loadImages(sources, callback) {
            var images = {};
            var loadedImages = 0;
            var numImages = sources.length;

            for (var src in sources) {
                var path = sources[src];
                if (path.includes("#")) {
                    images[src] = path;
                    ++loadedImages;
                    continue;
                }
                images[src] = new Image();
                images[src].onload = function() {
                    if (++loadedImages >= numImages) {
                        callback(images);
                    }
                };
                images[src].src = path;
            }
        }

        function getImagePath(char, itter) {
            var imageNum = seededRandom(seedBox.value + itter, validChars[char]) + 1;
            char = char.replace("!", "exclamation").replace("?", "question").replace(".", "dot").replace("$", "dollar");
            return 'chars/' + char + imageNum + ".png";
        }

        function seededRandom(seed, max) {
            //mulberry32 algorithm
            var t = seed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            var randNum = ((t ^ t >>> 14) >>> 0) / 4294967296.0;
            return Math.floor(randNum * Math.floor(max));
        }

        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }
    </script>
</body>

</html>